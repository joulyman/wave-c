# ğŸ¨ è‡ªé€‚åº” GUI ç¤ºä¾‹
# Fate å®Œå…¨è‡ªç”±é€‚åº”ç¯å¢ƒ

use drivers/bridge
use drivers/fate_adapt

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åº”ç”¨çŠ¶æ€
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app {
    color: 0xFF0000
    x: 100
    y: 100
    running: true
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç»˜åˆ¶å‡½æ•°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn draw_rect x y w h color {
    row = 0
    loop {
        when row >= h { break }
        col = 0
        loop {
            when col >= w { break }
            bridge.pixel (x + col) (y + row) color
            col = col + 1
        }
        row = row + 1
    }
}

fn draw_frame {
    # æ¸…å± (ç”¨ Fate çš„ quality å†³å®šæ˜¯å¦å…¨æ¸…)
    when fate.quality > 0.5 {
        draw_rect 0 0 bridge.width bridge.height 0x000000
    }
    
    # ç»˜åˆ¶ç§»åŠ¨çš„æ–¹å—
    size = 50 * fate.quality
    when size < 10 { size = 10 }
    
    draw_rect app.x app.y size size app.color
    
    # ç§»åŠ¨
    app.x = app.x + 2
    when app.x > bridge.width {
        app.x = 0
        # æ”¹å˜é¢œè‰²
        app.color = app.color + 0x010101
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¾“å…¥å¤„ç†
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn handle_input {
    when bridge.has_input() {
        event = bridge.read_input()
        
        # ESC é€€å‡º
        when event == 0x01 {
            app.running = false
        }
        
        # æ–¹å‘é”®
        when event == 0x48 { app.y = app.y - 10 }
        when event == 0x50 { app.y = app.y + 10 }
        when event == 0x4B { app.x = app.x - 10 }
        when event == 0x4D { app.x = app.x + 10 }
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¸»å¾ªç¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn main {
    # Fate è§‚æµ‹ç¯å¢ƒ
    fate.observe()
    
    out "=== è‡ªé€‚åº” GUI ==="
    out "æ˜¾ç¤º: "
    out bridge.width
    out "x"
    out bridge.height
    out " åƒç´ : "
    out fate.pixels
    
    loop {
        fate.measure_begin()
        
        handle_input()
        draw_frame()
        
        fate.measure_end()
        fate.adjust()
        
        # è¾“å‡º Fate çŠ¶æ€
        out "Fate: batch="
        out fate.batch_size
        out " quality="
        out fate.quality
        out " fps="
        when fate.avg_frame_time > 0 {
            fps = @addr.time.freq / fate.avg_frame_time
            out fps
        }
        
        when app.running == false { break }
    }
    
    out "é€€å‡º"
}

main()
