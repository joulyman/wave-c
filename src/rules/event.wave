# ğŸŒŠ Wave äº‹ä»¶ç³»ç»Ÿ
# äº‹ä»¶å¤„ç†ï¼šè§„åˆ™é©±åŠ¨çš„äº¤äº’ç®¡ç†

use rules/gui
use rules/fate

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# äº‹ä»¶ç±»å‹ (åˆ†æ”¯è§„å¾‹ï¼šå¤šç§å¯èƒ½)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

event_type {
    click: 1
    hover: 2
    key: 3
    resize: 4
    close: 5
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# äº‹ä»¶å®šä¹‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

event {
    type: 0
    x: 0
    y: 0
    button: 0
    key: 0
    modifiers: 0
}

# äº‹ä»¶å¤„ç†å™¨
handler {
    target: ""
    event_type: 0
    callback: null
}

# å¤„ç†å™¨åˆ—è¡¨
handlers: []

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# äº‹ä»¶ç»‘å®š (è¿æ¥è§„å¾‹ï¼šäº‹ä»¶ä¸å¤„ç†å™¨è¿æ¥)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn event.bind target etype callback {
    h = {
        target: target
        event_type: etype
        callback: callback
    }
    handlers <- h
}

fn event.unbind target etype {
    # ç§»é™¤å¤„ç†å™¨
    handlers -> filter h {
        -> h.target != target || h.event_type != etype
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç‚¹å‡»åŒºåŸŸ (è¾¹ç•Œè§„å¾‹ï¼šå®šä¹‰å“åº”åŒºåŸŸ)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

click_area {
    x: 0
    y: 0
    width: 0
    height: 0
    action: ""
    data: ""
}

click_areas: []

fn click.add x y w h action data {
    area = {
        x: x
        y: y
        width: w
        height: h
        action: action
        data: data
    }
    click_areas <- area
}

fn click.hit_test px py {
    click_areas -> each area {
        when px >= area.x {
            when px < area.x + area.width {
                when py >= area.y {
                    when py < area.y + area.height {
                        -> area
                    }
                }
            }
        }
    }
    -> null
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# äº‹ä»¶åˆ†å‘ (è½¨é“è§„å¾‹ï¼šäº‹ä»¶å¾ªç¯)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn event.dispatch e {
    handlers -> each h {
        when h.event_type == e.type {
            # æ£€æŸ¥ç›®æ ‡
            when h.target == "*" {
                h.callback(e)
            }
            
            # æ£€æŸ¥ç»„ä»¶
            components -> each c {
                when c.id == h.target {
                    when e.type == event_type.click {
                        when event.in_bounds(e.x, e.y, c) {
                            h.callback(e)
                        }
                    }
                }
            }
        }
    }
}

fn event.in_bounds x y c {
    when x >= c.x {
        when x < c.x + c.width {
            when y >= c.y {
                when y < c.y + c.height {
                    -> true
                }
            }
        }
    }
    -> false
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# äº‹ä»¶å¾ªç¯ (è½¨é“ + è®°å¿†è§„å¾‹ï¼šæŒç»­è¿è¡Œ)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

event_loop {
    running: false
    close_signal: false
}

fn event.start {
    event_loop.running = true
    event_loop.close_signal = false
    
    # Fate åˆ†é…èµ„æº
    fate.allocate(50)
    
    # è¿›å…¥å¾ªç¯
    loop {
        when event_loop.close_signal {
            break
        }
        
        # è½®è¯¢äº‹ä»¶
        e = event.poll()
        when e != null {
            event.dispatch(e)
        }
        
        # Collapse æ£€æŸ¥
        when fate.should_collapse() {
            fate.collapse()
        }
    }
    
    # é‡Šæ”¾èµ„æº
    fate.release()
}

fn event.stop {
    event_loop.close_signal = true
}

fn event.poll {
    # ä»å¹³å°è·å–äº‹ä»¶
    # ç®€åŒ–ï¼šè¿”å› null
    -> null
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# keep å®ç° (è®°å¿† + è½¨é“è§„å¾‹ï¼šä¿æŒç»“æ„)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn keep.activate {
    # ä¿æŒå½“å‰ç»“æ„ï¼šçª—å£ã€ç»„ä»¶ã€äº‹ä»¶ç»‘å®š
    event.start()
}

# å…³é—­æ¡ä»¶
fn keep.on_close_button {
    event.stop()
}

fn keep.on_escape {
    event.stop()
}

fn keep.on_quit {
    event.stop()
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# äº‹ä»¶è¯­æ³•æ”¯æŒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

intent on.click {
    action: event.bind(target, event_type.click, callback)
}

intent on.hover {
    action: event.bind(target, event_type.hover, callback)
}

intent on.key {
    action: event.bind(target, event_type.key, callback)
}

intent click {
    action: click.add
}

intent key {
    action: event.bind("*", event_type.key, callback)
}

intent keep {
    action: keep.activate
}
