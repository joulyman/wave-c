# ğŸŒŠ Wave å›¾å½¢ç³»ç»Ÿ
# çŸ¢é‡åˆ°åƒç´ ï¼šè§„åˆ™é©±åŠ¨çš„å›¾å½¢æ¸²æŸ“

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å¸§ç¼“å†²åŒº (boundary è§„å¾‹ï¼šä»£æ•°åŒ–è¾¹ç•Œ)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

framebuffer {
    # ä»£æ•°åŒ–ï¼šç”± fate åŠ¨æ€å†³å®š
    width: fate.display.w
    height: fate.display.h
    base: tile.graphics.base
    stride: fate.display.w * 4
    
    # æ¯”ä¾‹ç³»æ•° (0.0 - 1.0)
    scale: 1.0
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä»£æ•°åŒ–å¸ƒå±€ (æ¯”ä¾‹é©±åŠ¨)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

layout {
    # ç›¸å¯¹æ¯”ä¾‹ (1.0 = ç¯å¢ƒæœ€å¤§å€¼)
    ratio: 1.0
    aspect: 4/3      # å®½é«˜æ¯”
}

fn layout.apply {
    # fate æ¢æµ‹ç¯å¢ƒ
    env_w = fate.probe_width()
    env_h = fate.probe_height()
    
    # æŒ‰æ¯”ä¾‹è®¡ç®—
    framebuffer.width = env_w * layout.ratio
    framebuffer.height = framebuffer.width / layout.aspect
    
    # è¾¹ç•Œæ£€æŸ¥
    when framebuffer.height > env_h {
        framebuffer.height = env_h * layout.ratio
        framebuffer.width = framebuffer.height * layout.aspect
    }
    
    framebuffer.stride = framebuffer.width * 4
}

fn layout.ratio r {
    layout.ratio = r
    layout.apply()
}

fn layout.aspect a {
    layout.aspect = a
    layout.apply()
}

# å¸¸ç”¨æ¯”ä¾‹é¢„è®¾ï¼ˆä»£æ•°å½¢å¼ï¼‰
fn layout.quarter { layout.ratio(0.25) }
fn layout.half { layout.ratio(0.5) }
fn layout.full { layout.ratio(1.0) }

# å¸¸ç”¨å®½é«˜æ¯”
fn layout.widescreen { layout.aspect(16/9) }
fn layout.standard { layout.aspect(4/3) }
fn layout.square { layout.aspect(1/1) }

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä»£æ•°åæ ‡è½¬æ¢ (0.0-1.0 â†’ åƒç´ )
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn to_px_x r {
    # æ¯”ä¾‹ â†’ åƒç´ 
    framebuffer.width * r
}

fn to_px_y r {
    framebuffer.height * r
}

# ä»£æ•°åŒ–ç»˜å›¾ï¼ˆä½¿ç”¨ 0.0-1.0 æ¯”ä¾‹åæ ‡ï¼‰
fn draw.a_rect rx ry rw rh color {
    x = to_px_x(rx)
    y = to_px_y(ry)
    w = to_px_x(rw)
    h = to_px_y(rh)
    shape.add_rect(x, y, w, h, color)
}

fn draw.a_circle rx ry rr color {
    x = to_px_x(rx)
    y = to_px_y(ry)
    r = to_px_x(rr)  # ä½¿ç”¨å®½åº¦ä½œä¸ºåŸºå‡†
    shape.add_circle(x, y, r, color)
}

fn draw.a_text rx ry text color {
    x = to_px_x(rx)
    y = to_px_y(ry)
    shape.add_text(x, y, text, color)
}

fn draw.a_line rx1 ry1 rx2 ry2 color {
    x1 = to_px_x(rx1)
    y1 = to_px_y(ry1)
    x2 = to_px_x(rx2)
    y2 = to_px_y(ry2)
    shape.add_line(x1, y1, x2, y2, color)
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å½¢çŠ¶å®šä¹‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

shape_type {
    line: 1
    rect: 2
    circle: 3
    text: 4
}

shape {
    type: 0
    x1: 0
    y1: 0
    x2: 0
    y2: 0
    color: 0xFFFFFF
    filled: true
}

# å½¢çŠ¶åˆ—è¡¨
shapes: []

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å½¢çŠ¶æ·»åŠ å‡½æ•° (è¿æ¥è§„å¾‹ï¼šå»ºç«‹å½¢çŠ¶å…³ç³»)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn shape.add_line x1 y1 x2 y2 color {
    shapes <- { type: shape_type.line, x1: x1, y1: y1, x2: x2, y2: y2, color: color }
}

fn shape.add_rect x y w h color {
    shapes <- { type: shape_type.rect, x1: x, y1: y, x2: w, y2: h, color: color, filled: true }
}

fn shape.add_circle cx cy r color {
    shapes <- { type: shape_type.circle, x1: cx, y1: cy, x2: r, color: color, filled: true }
}

fn shape.add_text x y text color {
    shapes <- { type: shape_type.text, x1: x, y1: y, text: text, color: color }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åƒç´ æ“ä½œ (å¼ åŠ›è§„å¾‹ï¼šå¡«å……å‹åŠ›)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn pixel.set x y color {
    when x >= 0 {
        when x < framebuffer.width {
            when y >= 0 {
                when y < framebuffer.height {
                    addr = framebuffer.base + y * framebuffer.stride + x * 4
                    @addr = color
                }
            }
        }
    }
}

fn pixel.get x y {
    addr = framebuffer.base + y * framebuffer.stride + x * 4
    -> @addr
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å…‰æ …åŒ– (ç†µè§„å¾‹ï¼šç¦»æ•£åŒ–è¿ç»­å½¢çŠ¶)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn rasterize.line x1 y1 x2 y2 color {
    dx = x2 - x1
    dy = y2 - y1
    
    when dx < 0 { dx = 0 - dx }
    when dy < 0 { dy = 0 - dy }
    
    steps = dx
    when dy > dx { steps = dy }
    
    when steps > 0 {
        x_inc = (x2 - x1) / steps
        y_inc = (y2 - y1) / steps
        
        x = x1
        y = y1
        i = 0
        
        loop {
            when i > steps { break }
            pixel.set(x, y, color)
            x = x + x_inc
            y = y + y_inc
            i = i + 1
        }
    }
}

fn rasterize.rect x y w h color filled {
    when filled {
        row = 0
        loop {
            when row >= h { break }
            col = 0
            loop {
                when col >= w { break }
                pixel.set(x + col, y + row, color)
                col = col + 1
            }
            row = row + 1
        }
    }
}

fn rasterize.circle cx cy r color filled {
    when filled {
        y = 0 - r
        loop {
            when y > r { break }
            x = 0 - r
            loop {
                when x > r { break }
                when x*x + y*y <= r*r {
                    pixel.set(cx + x, cy + y, color)
                }
                x = x + 1
            }
            y = y + 1
        }
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ¸²æŸ“ (æ¼”åŒ–è§„å¾‹ï¼šå½¢çŠ¶æ¼”åŒ–ä¸ºåƒç´ )
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn render {
    shapes -> each shape {
        when shape.type == shape_type.line {
            rasterize.line(shape.x1, shape.y1, shape.x2, shape.y2, shape.color)
        }
        when shape.type == shape_type.rect {
            rasterize.rect(shape.x1, shape.y1, shape.x2, shape.y2, shape.color, shape.filled)
        }
        when shape.type == shape_type.circle {
            rasterize.circle(shape.x1, shape.y1, shape.x2, shape.color, shape.filled)
        }
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¾“å‡º (è®°å¿†è§„å¾‹ï¼šæŒä¹…åŒ–)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn save filename {
    # å†™ PPM æ–‡ä»¶
    out "P6\n"
    out framebuffer.width
    out " "
    out framebuffer.height
    out "\n255\n"
    
    y = 0
    loop {
        when y >= framebuffer.height { break }
        x = 0
        loop {
            when x >= framebuffer.width { break }
            color = pixel.get(x, y)
            r = (color >> 16) & 0xFF
            g = (color >> 8) & 0xFF
            b = color & 0xFF
            emit r
            emit g
            emit b
            x = x + 1
        }
        y = y + 1
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# draw.* è¯­æ³•æ”¯æŒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

intent draw.line {
    action: shape.add_line
}

intent draw.rect {
    action: shape.add_rect
}

intent draw.circle {
    action: shape.add_circle
}

intent draw.text {
    action: shape.add_text
}

intent draw.render {
    action: render
}

intent draw.save {
    action: save
}
