# ğŸŒŠ Fate è°ƒåº¦å™¨
# å…¨å±€åŠ¨æ€ä¼˜åŒ– â€” æ— ç¡¬ç¼–ç ï¼Œä»£æ•°å½¢å¼
#
# fate on (é»˜è®¤) â†’ åŠ¨æ€ä¼˜åŒ–
# fate off       â†’ é™æ€ä»£ç 

use rules/unified
use rules/tile

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Fate çŠ¶æ€ â€” ä»£æ•°å½¢å¼
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fate {
    on: true              # é»˜è®¤å¼€å¯
    adapters: []          # é€‚é…å™¨åˆ—è¡¨
    id_counter: 0         # ID åˆ†é…è®¡æ•°å™¨
    learned: {}           # å­¦ä¹ åˆ°çš„æ¨¡å¼
}

# è§‚æµ‹å€¼ â€” è¿è¡Œæ—¶ç”± Fate å¡«å……
observe {
    usage: 0              # èµ„æºä½¿ç”¨ç‡ [0, 1]
    gain: 0               # å½“å‰æ”¶ç›Š
    prev_gain: 0          # ä¸Šæ¬¡æ”¶ç›Š
    pattern: 0            # æ¨¡å¼è®¡æ•°
}

# ç»Ÿä¸€åœºå‚æ•° â€” ä»£æ•°ç¬¦å·
field {
    i: 0.5                # ä¿¡æ¯å¯†åº¦
    e: 0.5                # ç†µæ¢¯åº¦
    r: 0.5                # å…³ç³»å¼ºåº¦
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é€‚é…å™¨ç®¡ç†
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn fate.register_adapter id callback {
    fate.adapters <- { id: id, adapt: callback }
}

fn fate.next_id {
    fate.id_counter = fate.id_counter + 1
    -> fate.id_counter
}

# åœ°å€åˆ†é… â€” Fate åŠ¨æ€å†³å®š
fn fate.next_addr {
    # åŸºäºå½“å‰çŠ¶æ€è®¡ç®—ä¸‹ä¸€ä¸ªå¯ç”¨åœ°å€
    addr = fate.recall("last_addr")
    when addr == 0 {
        addr = 0x10000  # é¦–æ¬¡åˆ†é…èµ·å§‹
    }
    size = fate.recall("last_size")
    when size == 0 {
        size = 0x10000
    }
    next = addr + size
    fate.learn("last_addr", next)
    -> next
}

fn fate.next_size {
    # åŸºäºè§‚æµ‹å†³å®šæ± å¤§å°
    # ä½¿ç”¨ç‡é«˜ â†’ å¤§æ± 
    # ä½¿ç”¨ç‡ä½ â†’ å°æ± 
    base = 0x10000
    when observe.usage > 0.7 {
        -> base * 2
    }
    when observe.usage < 0.3 {
        -> base / 2
    }
    -> base
}

fn fate.run_adapters {
    when fate.on == false { return }
    
    i = 0
    loop {
        when i >= len(fate.adapters) { break }
        fate.adapters[i].adapt()
        i = i + 1
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å­¦ä¹ ç³»ç»Ÿ â€” è®°å½•æˆåŠŸæ¨¡å¼
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn fate.learn key value {
    fate.learned[key] = value
}

fn fate.recall key {
    -> fate.learned[key]
}

fn fate.emit_learned key id {
    pattern = fate.learned[key + ":" + id]
    when pattern {
        emit pattern
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è§‚æµ‹ â€” æ”¶é›†è¿è¡Œæ—¶æ•°æ®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn fate.observe {
    when fate.on == false { return }
    
    # è§‚æµ‹èµ„æºä½¿ç”¨
    observe.usage = tile.ratio()
    
    # è§‚æµ‹æ¨¡å¼
    observe.pattern = observe.pattern + 1
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é€‚åº” â€” æ ¹æ®è§‚æµ‹è°ƒæ•´åœºå‚æ•°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn fate.adapt {
    when fate.on == false { return }
    
    # è¿è¡Œæ‰€æœ‰é€‚é…å™¨
    fate.run_adapters()
    
    # æ ¹æ®è§‚æµ‹è°ƒæ•´åœºå‚æ•°
    # i = f(usage, pattern)
    # e = g(usage, pattern)  
    # r = h(usage, pattern)
    
    when observe.usage > 0.7 {
        field.e = field.e + 0.1
    }
    when observe.pattern > observe.prev_pattern {
        field.r = field.r + 0.05
    }
    
    observe.prev_pattern = observe.pattern
    
    # ä¼ é€’åˆ°ç»Ÿä¸€åœº
    unified.set(field.i, field.e, field.r)
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Collapse â€” é™æ€åŒ–
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn fate.should_collapse {
    delta = observe.gain - observe.prev_gain
    observe.prev_gain = observe.gain
    
    # è¾¹é™…æ”¶ç›Šé€’å‡ â†’ é™æ€åŒ–
    when delta < 0.05 {
        -> true
    }
    -> false
}

fn fate.collapse {
    # å›ºåŒ–å½“å‰åœºå‚æ•°
    fate.learn("static:i", field.i)
    fate.learn("static:e", field.e)
    fate.learn("static:r", field.r)
    
    # å…³é—­åŠ¨æ€ä¼˜åŒ–
    fate.on = false
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¸»å¾ªç¯ â€” è§‚æµ‹ã€é€‚åº”ã€æ£€æŸ¥åå¡Œ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn fate.tick {
    when fate.on == false { return }
    
    fate.observe()
    fate.adapt()
    
    when fate.should_collapse() {
        fate.collapse()
    }
}

fn fate.optimize_loop body {
    loop {
        result = body()
        observe.gain = result
        
        fate.tick()
        
        when fate.on == false { break }
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åˆå§‹åŒ–
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn fate.init {
    fate.on = true        # é»˜è®¤å¼€å¯
    fate.adapters = []
    fate.id_counter = 0
    fate.learned = {}
    
    observe.usage = 0
    observe.gain = 0
    observe.prev_gain = 0
    observe.pattern = 0
    
    field.i = 0.5
    field.e = 0.5
    field.r = 0.5
    
    unified.init()
    tile.init()
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# fate on / fate off
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn fate.enable {
    fate.on = true
}

fn fate.disable {
    fate.on = false
}

intent "fate on" {
    action: fate.enable
}

intent "fate off" {
    action: fate.disable
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æŠ¥å‘Š
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn fate.report {
    out "[Fate] on:"
    out fate.on
    out " usage:"
    out observe.usage
    out " field(i:"
    out field.i
    out " e:"
    out field.e
    out " r:"
    out field.r
    out ")"
}
