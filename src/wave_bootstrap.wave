# ğŸŒŠ Wave è‡ªä¸¾ç¼–è¯‘å™¨
# è¯»å– Wave æºç  â†’ è¾“å‡ºçº¯äºŒè¿›åˆ¶æœºå™¨ç 
# ç”¨æ³•: ./bootstrap < source.wave > output.bin

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# çŠ¶æ€å˜é‡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ch = 0          # å½“å‰å­—ç¬¦
pos = 0         # ä½ç½®

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fn next {
    ch = getchar()
    pos = pos + 1
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è·³è¿‡ç©ºç™½
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fn skip_space {
    loop {
        when ch != 32 {
            when ch != 10 {
                when ch != 9 {
                    break
                }
            }
        }
        next()
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è·³è¿‡æ³¨é‡Š (#...)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fn skip_comment {
    when ch == 35 {
        loop {
            when ch == 10 { break }
            when ch == 0 { break }
            next()
        }
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# x86-64 ä»£ç ç”Ÿæˆ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn gen_mov_rax n {
    byte(0x48)
    byte(0xb8)
    byte(n)
    byte(n / 256)
    byte(n / 65536)
    byte(n / 16777216)
    byte(0)
    byte(0)
    byte(0)
    byte(0)
}

fn gen_mov_rdi n {
    byte(0x48)
    byte(0xbf)
    byte(n)
    byte(n / 256)
    byte(n / 65536)
    byte(n / 16777216)
    byte(0)
    byte(0)
    byte(0)
    byte(0)
}

fn gen_mov_rdx n {
    byte(0x48)
    byte(0xba)
    byte(n)
    byte(n / 256)
    byte(n / 65536)
    byte(n / 16777216)
    byte(0)
    byte(0)
    byte(0)
    byte(0)
}

fn gen_syscall {
    byte(0x0f)
    byte(0x05)
}

fn gen_exit code {
    gen_mov_rax(60)
    gen_mov_rdi(code)
    gen_syscall()
}

fn gen_write_byte b {
    # push byte; write 1; pop
    byte(0x6a)      # push imm8
    byte(b)
    gen_mov_rax(1)
    gen_mov_rdi(1)
    byte(0x48)      # mov rsi, rsp
    byte(0x89)
    byte(0xe6)
    gen_mov_rdx(1)
    gen_syscall()
    byte(0x58)      # pop rax
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è§£ææ•°å­—
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fn parse_num {
    n = 0
    loop {
        when ch < 48 { break }
        when ch > 57 { break }
        n = n * 10 + ch - 48
        next()
    }
    -> n
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç¼–è¯‘ out "string"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fn compile_out {
    skip_space()
    when ch == 34 {
        next()
        # è®¡ç®—å­—ç¬¦ä¸²å¹¶è¾“å‡º
        loop {
            when ch == 34 { break }
            when ch == 0 { break }
            
            when ch == 92 {
                # è½¬ä¹‰
                next()
                when ch == 110 { gen_write_byte(10) }
                when ch == 116 { gen_write_byte(9) }
            }
            otherwise {
                gen_write_byte(ch)
            }
            next()
        }
        next()
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç¼–è¯‘ byte(n)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fn compile_byte {
    skip_space()
    when ch == 40 {
        next()
        skip_space()
        n = parse_num()
        skip_space()
        when ch == 41 { next() }
        gen_write_byte(n)
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¸»ç¼–è¯‘å¾ªç¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fn compile {
    next()
    
    loop {
        skip_space()
        skip_comment()
        
        when ch == 0 { break }
        when ch == 255 { break }
        
        # out "..."
        when ch == 111 {
            next()
            when ch == 117 {
                next()
                when ch == 116 {
                    next()
                    compile_out()
                }
            }
        }
        
        # byte(n)
        when ch == 98 {
            next()
            when ch == 121 {
                next()
                when ch == 116 {
                    next()
                    when ch == 101 {
                        next()
                        compile_byte()
                    }
                }
            }
        }
        
        # å…¶ä»–ï¼šè·³åˆ°ä¸‹ä¸€è¡Œ
        loop {
            when ch == 10 { break }
            when ch == 0 { break }
            next()
        }
        next()
    }
    
    gen_exit(0)
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å…¥å£
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
compile()
