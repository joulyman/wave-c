# ğŸŒ‰ Wave æœ€å°é€šç”¨æ¡¥æ¥
# å¹³å°æ— å…³ï¼ŒFate è‡ªç”±é€‚åº”

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ ‡å‡†å†…å­˜åè®® (å¤–éƒ¨æ³¨å…¥è¿™äº›åœ°å€)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# æ˜¾ç¤º
addr.display.fb      = 0x1000    # å¸§ç¼“å†²æŒ‡é’ˆ
addr.display.width   = 0x1004    # å®½åº¦
addr.display.height  = 0x1008    # é«˜åº¦
addr.display.pitch   = 0x100C    # æ¯è¡Œå­—èŠ‚æ•°
addr.display.format  = 0x1010    # åƒç´ æ ¼å¼
addr.display.ready   = 0x1014    # å°±ç»ªæ ‡å¿—

# è¾“å…¥
addr.input.buffer    = 0x2000    # è¾“å…¥ç¼“å†²åŒº
addr.input.head      = 0x2004    # é˜Ÿåˆ—å¤´
addr.input.tail      = 0x2008    # é˜Ÿåˆ—å°¾
addr.input.ready     = 0x200C    # å°±ç»ªæ ‡å¿—

# æ—¶é—´
addr.time.ticks      = 0x3000    # æ—¶é—´æˆ³
addr.time.freq       = 0x3004    # é¢‘ç‡

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ¡¥æ¥çŠ¶æ€ (è¿è¡Œæ—¶å¡«å……)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bridge {
    display_ready: false
    input_ready: false
    fb: 0
    width: 0
    height: 0
    pitch: 0
    format: 0
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¯»å–ç¯å¢ƒ (ä¸å‡è®¾ä»»ä½•å€¼)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn bridge.read_env {
    # æ£€æŸ¥æ˜¾ç¤ºæ˜¯å¦å°±ç»ª
    bridge.display_ready = (@addr.display.ready == 1)
    
    when bridge.display_ready {
        bridge.fb = @addr.display.fb
        bridge.width = @addr.display.width
        bridge.height = @addr.display.height
        bridge.pitch = @addr.display.pitch
        bridge.format = @addr.display.format
    }
    
    # æ£€æŸ¥è¾“å…¥æ˜¯å¦å°±ç»ª
    bridge.input_ready = (@addr.input.ready == 1)
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åƒç´ å†™å…¥ (æ ¼å¼è‡ªé€‚åº”)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn bridge.pixel x y color {
    when bridge.display_ready {
        offset = (y * bridge.pitch) + (x * 4)
        addr = bridge.fb + offset
        
        # æ ¹æ®æ ¼å¼è½¬æ¢é¢œè‰²
        when bridge.format == 0 {
            # RGBA - ç›´æ¥å†™
            @addr = color
        }
        when bridge.format == 1 {
            # BGRA - äº¤æ¢ R å’Œ B
            r = (color >> 16) & 0xFF
            g = (color >> 8) & 0xFF
            b = color & 0xFF
            a = (color >> 24) & 0xFF
            @addr = (a << 24) | (r << 0) | (g << 8) | (b << 16)
        }
        when bridge.format != 0 {
            when bridge.format != 1 {
                # æœªçŸ¥æ ¼å¼ - å°è¯•ç›´æ¥å†™
                @addr = color
            }
        }
    }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¾“å…¥è¯»å–
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn bridge.has_input {
    when bridge.input_ready {
        head = @addr.input.head
        tail = @addr.input.tail
        -> (head != tail)
    }
    -> false
}

fn bridge.read_input {
    when bridge.has_input() {
        head = @addr.input.head
        event = @(addr.input.buffer + head * 8)
        @addr.input.head = (head + 1) & 0xFF
        -> event
    }
    -> 0
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ—¶é—´
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fn bridge.ticks {
    -> @addr.time.ticks
}

fn bridge.wait_frame {
    start = bridge.ticks()
    target = start + (@addr.time.freq / 60)
    loop {
        when bridge.ticks() >= target { break }
    }
}
